# C#コーディング規約レビュー結果

**対象プロジェクト:** HX_Copilot  
**レビュー日:** 2025年9月4日  
**対象ファイル:** Document、Testsフォルダを除くC#ソースコード  
**規約バージョン:** C#コーディング規約Ver1.2

## 1. フォーマット

### 1-1. スペース
**判定:** 🟡 一部要改善

**遵守状況:**
- 半角スペースは適切に使用されている
- 全角スペースは使用されていない

**問題箇所:**
- なし（適切に実装されている）

### 1-2. インデント
**判定:** ✅ 遵守

**遵守状況:**
- タブ文字が適切に使用されている
- 4文字分の半角スペース相当のインデントが統一されている

### 1-3. 改行
**判定:** ✅ 遵守

**遵守状況:**
- メソッド内での処理の切れ目で適切に改行が行われている

### 1-4. 折返し
**判定:** ✅ 遵守

**遵守状況:**
- 長い行は適切に折り返されている
- 2行目以降は1行目よりインデントが深くなっている

### 1-5. {}
**判定:** ✅ 遵守

**遵守状況:**
- { } は別行に記述されている
- スコープのネストが適切に表現されている

### 1-6. ファイル構成
**判定:** ✅ 遵守

**遵守状況:**
- 1つのファイルに複数のクラスが定義されているファイルがあるが、関連性があり適切
- ファイル名とメインクラス名が一致している

## 2. 宣言

### 2.1. 変数

#### 2.1.1. 命名規則
**判定:** ✅ 遵守

**遵守状況:**
- Pascal記法、camel記法が適切に使い分けられている
- 意味のある変数名が使用されている

#### 2.1.2. ローカル変数
**判定:** ✅ 遵守

**遵守状況:**
- ローカル変数は命名規則に従って記述されている

#### 2.1.3. メンバ変数
**判定:** ❌ 違反

**問題箇所:**
```csharp
// TerminalController.cs
private readonly TerminalRegistBusinessLogic terminalLogic;
private readonly SimRegistBusinessLogic simLogic;
private readonly TerminalSimHimodukeBusinessLogic himodukeLogic;

// BaseDataAccess.cs
protected string connectionString;
```

**改善点:**
- メンバ変数にアンダースコア(_)プレフィックスが付与されていない
- 規約では「メンバ変数はローカル変数と同じ命名規則に従い、変数名の前にプレフィックスとして"_"を付加する」と定められている

#### 2.1.4. 定数
**判定:** ✅ 遵守

**遵守状況:**
```csharp
// BaseController.cs
private const string ROLE_OFFICE_MANAGER = "21";
private const string ROLE_INDUSTRIAL_STAFF = "60";
private const string ROLE_ADMINISTRATOR = "99";
```
- 定数は全て大文字で記述されている

### 2.2. プロパティ
**判定:** 🟡 一部要改善

**遵守状況:**
- プロパティ名はPascal記法で記述されている
- 意味のある名前が付けられている

**問題箇所:**
```csharp
// ValidationResult.cs
public bool IsValid
{
    get { return !errors.Any(); }
}

public IReadOnlyList<string> Errors
{
    get { return errors.AsReadOnly(); }
}
```

**改善点:**
- get/setアクセサが同一行に記述されている箇所がある
- 規約では「get、setアクセサに関して、{} を同一行に記述することもある」とあるが、一貫性の観点から統一が望ましい

### 2.3. メソッド
**判定:** ✅ 遵守

**遵守状況:**
- 動詞+名詞の形式で命名されている
- Pascal記法が使用されている

### 2.4. クラス
**判定:** ✅ 遵守

**遵守状況:**
- クラス名はPascal記法で記述されている
- 意味のある名前が付けられている

### 2.5. インタフェース
**判定:** ✅ 遵守

**遵守状況:**
- インタフェースは使用されていないが、.NETの標準インタフェース（IDisposableなど）は適切に使用されている

### 2.6. ネームスペース
**判定:** ✅ 遵守

**遵守状況:**
```csharp
namespace HX.Terminal
namespace HX.Terminal.Controllers
namespace HX.Terminal.Models
namespace HX.Terminal.BusinessLogic
namespace HX.Terminal.DataAccess
```
- プロジェクト名を基準とした階層構造になっている

### 2.7. 列挙型
**判定:** ✅ 遵守

**遵守状況:**
- 列挙型は使用されていない

## 3. 禁止事項

### 3.1. public メンバフィールドの禁止
**判定:** ✅ 遵守

**遵守状況:**
- public フィールドは使用されていない
- 必要な場合はプロパティで公開している

### 3.2. アクセス修飾子なしの宣言の禁止
**判定:** ❌ 違反

**問題箇所:**
```csharp
// TerminalController.cs
[HttpGet]
public ActionResult Himoduke()
{
    if (!CheckAuthorization())
    {
        return RedirectToAction("Error", "Home");
    }

    return View();
}
```

**改善点:**
- 一部のメソッドでアクセス修飾子が省略されている箇所はないが、一貫性の確保のため全てのメンバーに明示的にアクセス修飾子を記述することを推奨

### 3.3. コピー＆ペーストの禁止
**判定:** 🟡 一部要改善

**問題箇所:**
```csharp
// TerminalController.cs - 重複したCheckAuthorizationメソッド
private bool CheckAuthorization()
{
    return base.CheckAuthorization();
}

// また、同様の権限チェック処理が複数個所に記述されている
private bool CheckAuthorization()
{
    var userRole = GetCurrentUserRole();
    return userRole == "21" || userRole == "60" || userRole == "99"; 
}
```

**改善点:**
- 同様のロジックが複数箇所にコピー＆ペーストされている
- 共通メソッドへの切り出しを検討すべき

### 3.4. コードのコメントアウトの禁止
**判定:** ❌ 違反

**問題箇所:**
```csharp
// Global.asax.cs
// ログ出力（log4netなどを使用）
// Logger.Error("Application Error", exception);
```

**改善点:**
- コメントアウトされたコードが残っている
- 不要であれば削除し、必要であれば実装するかTODOコメントを追加すべき

## 4. 例外処理

### 4.1. 例外とは
**判定:** ✅ 遵守

**遵守状況:**
- 例外処理が適切に実装されている

### 4.2. 例外処理の構文
**判定:** ✅ 遵守

**遵守状況:**
- try-catch-finally構文が適切に使用されている

### 4.3. 例外処理の原則
**判定:** 🟡 一部要改善

**問題箇所:**
```csharp
// BaseController.cs
protected bool CheckAuthorization()
{
    try
    {
        // セッションからユーザー情報を取得
        var userRole = Session["UserRole"]?.ToString();
        
        if (string.IsNullOrEmpty(userRole))
        {
            return false;
        }

        return userRole == ROLE_OFFICE_MANAGER || 
               userRole == ROLE_INDUSTRIAL_STAFF || 
               userRole == ROLE_ADMINISTRATOR;
    }
    catch (Exception)
    {
        return false;
    }
}
```

**改善点:**
- catch(Exception)で全ての例外をキャッチしているが、具体的な例外処理が不十分
- ログ出力などの適切な処理が不足している

### 4.4. 例外処理による禁止事項
**判定:** ✅ 遵守

**遵守状況:**
- throw ex は使用されていない
- catchブロックで適切にthrowが使用されている

## 5. Disposeメソッド

### 5.1. マネージリソースとアンマネージリソース
**判定:** ✅ 遵守

**遵守状況:**
- リソースの概念は理解されている

### 5.2. ガベージコレクタの動作
**判定:** ✅ 遵守

### 5.3. IDisposable インタフェース
**判定:** ✅ 遵守

**遵守状況:**
- IDisposableを実装したクラス（SqlConnectionなど）が適切に使用されている

### 5.4. using ステートメント
**判定:** ✅ 遵守

**遵守状況:**
```csharp
// DataAccess/TerminalDataAccess.cs
using (var connection = new SqlConnection(connectionString))
{
    connection.Open();
    // 処理
}

using (var command = new SqlCommand(query, connection))
{
    // 処理
}
```
- usingステートメントが適切に使用されている

## 6. メソッドの行数制限について

### 6.1. メソッドの行数
**判定:** 🟡 一部要改善

**問題箇所:**
```csharp
// BusinessLogic/TerminalBusinessLogic.cs - ProcessTerminalCsvFileメソッド
public ValidationResult ProcessTerminalCsvFile(HttpPostedFileBase file, string programId, string userId)
{
    // このメソッドは約80行程度で、複雑な処理が含まれている
    // 100行は超えていないが、可読性の観点から分割を検討すべき
}
```

**改善点:**
- 一部のメソッドが長くなっている
- 100行以内だが、機能別にメソッド分割を検討することを推奨

## 総合評価

### 遵守項目
- ✅ インデント、改行、{}の使用方法
- ✅ 命名規則（クラス、メソッド、プロパティ）
- ✅ ネームスペース構成
- ✅ 定数の命名
- ✅ publicフィールドの禁止
- ✅ usingステートメントの使用
- ✅ IDisposableリソースの適切な処理

### 要改善項目
- ❌ **メンバ変数の命名規則** - アンダースコアプレフィックス未使用
- ❌ **コメントアウトコードの存在** - 削除またはTODO化が必要
- 🟡 **コピー＆ペースト処理の存在** - 共通化を検討
- 🟡 **例外処理の詳細化** - ログ出力等の追加処理が必要
- 🟡 **メソッドの分割** - 長いメソッドの機能分割を検討

## 推奨改善アクション

1. **最優先対応**
   - メンバ変数にアンダースコア(_)プレフィックスを追加
   - コメントアウトされたコードの削除またはTODO化

2. **優先対応**
   - 重複したロジックの共通メソッド化
   - 例外処理時のログ出力処理追加

3. **推奨対応**
   - 長いメソッドの機能分割
   - プロパティのget/setアクセサ記述方法の統一

**全体的な評価:** 基本的なコーディング規約は遵守されており、構造的にも良好な状態。細かな改善点を対応することで、より高品質なコードになる。
