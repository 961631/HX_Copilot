# C#コーディング規約レビュー結果

**レビュー対象:** HX_COPILOT配下のソースコード（Document、Tests除く）  
**レビュー日付:** 2025年9月2日  
**使用規約:** C#コーディング規約.txt Ver 1.2

## 対象ファイル
- `Controllers/BaseController.cs`
- `Controllers/TerminalController.cs`
- `Models/TerminalRegistModel.cs`
- `Models/ValidationResult.cs`
- `BusinessLogic/TerminalBusinessLogic.cs`
- `DataAccess/TerminalDataAccess.cs`
- `Global.asax.cs`

---

## 1. フォーマット

### 1-1. スペース
**結果:** 🟡 **一部要改善**

**準拠箇所:**
- 演算子の前後のスペースは概ね適切
- コメント「//」の直後にスペースが適切に配置
- メソッド呼び出しの「(」直前にスペースなし（適切）
- カンマ「,」の後にスペースが適切に配置

**要改善箇所:**
```csharp
// BaseController.cs 行49-51
return userRole == ROLE_OFFICE_MANAGER || 
       userRole == ROLE_INDUSTRIAL_STAFF || 
       userRole == ROLE_ADMINISTRATOR;
```
**問題点:** 論理演算子 `||` の後に不要なスペースが配置されている

### 1-2. インデント
**結果:** ✅ **適合**

- タブ(Tab)キーを使用し、半角スペース4つ相当で統一されている
- ネストレベルに応じた適切なインデントが維持されている

### 1-3. 空行
**結果:** ✅ **適合**

- メソッド間で適切に空行が挿入されている
- 論理的なブロック間で空行による区切りが適切に使用されている

```csharp
// 適切な例：TerminalController.cs
var file = Request.Files["terminalFile"];

// ファイルバリデーション（空行で処理ブロックを区切り）
var fileValidation = terminalLogic.ValidateCsvFile(file);

// CSVファイル処理（空行で処理ブロックを区切り）
var result = terminalLogic.ProcessTerminalCsvFile(file, "Regist.aspx", GetCurrentUserId());
```

### 1-4. 改行
**結果:** 🟡 **一部要改善**

**準拠箇所:**
```csharp
// 適切な改行の例：BusinessLogic/TerminalBusinessLogic.cs
var model = new TerminalRegistModel
{
    TerminalNo1 = columns[1]?.Trim(),
    TerminalNo2 = columns[2]?.Trim(),
    PinCode = columns[3]?.Trim(),
    ItemCode = columns[5]?.Trim()
};
```

**要改善箇所:**
```csharp
// TerminalController.cs 行96
return Json(new { success = false, message = string.Join("\n", fileValidation.Errors) });

// TerminalController.cs 行104, 108, 113, 131, 139, 143, 148, 240, 244, 249
// 同様の長い行が複数存在

// BusinessLogic/TerminalBusinessLogic.cs 行84
result.AddError($"端末製造番号：{model.TerminalNo1}の桁数が正しくないためエラーとなりました。内容を確認し、再度アップロードしてください。");
```
**問題点:** 横に長い行（100文字超）が複数存在し、横スクロールが必要になる可能性。改行位置は処理の切れ目で行い、2行目以降は1行目よりインデントを深くする規則に従う必要がある。

### 1-5. {}
**結果:** ✅ **適合**

- すべての`{}`が宣言と同じ行ではなく、必ず改行して記述されている
- クラス、メソッド、プロパティ等のスコープで適切に使用されている

### 1-6. ファイル分割
**結果:** ⚠️ **一部問題あり**

**準拠箇所:**
- ほとんどのファイルが1ファイル1クラスの原則に従っている
- ファイル名とクラス名が一致している

**問題箇所:**
```csharp
// TerminalRegistModel.cs 行62-68
}
}

/// <summary>
/// SIM情報登録モデル
/// </summary>
public class SimRegistModel
```
**問題点:** `TerminalRegistModel.cs`に`SimRegistModel`クラスも含まれており、1ファイル1クラスの原則に違反

---

## 2. 宣言

### 2.1. 変数

#### 2.1.1. 通常規則
**結果:** ✅ **適合**

- すべての変数が通常規則に従って宣言されている
- 単語の区切りは大文字で表現されている（camelCase）

```csharp
// 適切な例
var fileValidation = terminalLogic.ValidateCsvFile(file);
var terminalList = new List<TerminalRegistModel>();
```

#### 2.1.2. ローカル変数
**結果:** ✅ **適合**

- ローカル変数は通常規則に従ってcamelCaseで記述されている

#### 2.1.3. メンバー変数
**結果:** ✅ **適合**

```csharp
// BaseController.cs
private readonly TerminalRegistBusinessLogic terminalLogic;

// ValidationResult.cs
private readonly List<string> errors;
```
- メンバー変数にはプレフィックス「_」は使用されていないが、規約上は使用も可

#### 2.1.4. 定数
**結果:** ✅ **適合**

```csharp
// BaseController.cs
private const string ROLE_OFFICE_MANAGER = "21";
private const string ROLE_INDUSTRIAL_STAFF = "60";
private const string ROLE_ADMINISTRATOR = "99";
```
- 定数は全て大文字で記述されている

### 2.2. プロパティ
**結果:** ✅ **適合**

```csharp
// ValidationResult.cs
public bool IsValid { get { return !errors.Any(); } }
public IReadOnlyList<string> Errors { get { return errors.AsReadOnly(); } }

// TerminalRegistModel.cs
public DateTime CreatedDate { get; set; }
public string CreatedProgramId { get; set; }
```
- プロパティは大文字で始まるPascalCaseで記述されている
- 単純なアクセサーは同一行に記述されている

### 2.3. メソッド
**結果:** ✅ **適合**

```csharp
public ActionResult Top()
public ValidationResult ValidateCsvFile(HttpPostedFileBase file)
protected bool CheckAuthorization()
```
- メソッドは動詞+名詞の形式でPascalCaseで記述されている

### 2.4. クラス
**結果:** ✅ **適合**

```csharp
public class TerminalController : BaseController
public class ValidationResult
public class TerminalRegistBusinessLogic
```
- クラス名は大文字で始まるPascalCaseで記述されている
- クラスの役割が明確になる命名がされている

### 2.5. インターフェース
**結果:** N/A **該当なし**

- 対象ファイル内にインターフェースの宣言は存在しない

### 2.6. ネームスペース
**結果:** ✅ **適合**

```csharp
namespace HX.Terminal.Controllers
namespace HX.Terminal.Models
namespace HX.Terminal.BusinessLogic
namespace HX.Terminal.DataAccess
```
- プロジェクト単位で統一されたネームスペース命名

### 2.7. 列挙型
**結果:** N/A **該当なし**

- 対象ファイル内に列挙型の宣言は存在しない

---

## 3. 禁止事項

### 3.1. public メンバーフィールドの禁止
**結果:** ✅ **適合**

- すべてのフィールドがprivateまたはprotectedで宣言されている
- 外部アクセスが必要な場合はプロパティを使用している

### 3.2. アクセス修飾子なしの宣言の禁止
**結果:** ✅ **適合**

- すべての宣言で適切なアクセス修飾子が指定されている

### 3.3. コピー＆ペーストの禁止
**結果:** ✅ **適合**

- 同様の処理は適切にメソッド化されている
- 明らかなコピー＆ペーストコードは見当たらない

### 3.4. コードのコメントアウトの禁止
**結果:** 🟡 **一部要注意**

```csharp
// Global.asax.cs 行23
// Logger.Error("Application Error", exception);
```
**問題点:** コメントアウトされたコードが残っている。ただし、実装例として残している可能性あり

---

## 4. 例外処理

### 4.1. 例外とは
**結果:** ✅ **理解されている**

- 例外処理が適切に実装されている

### 4.2. 例外処理の構文
**結果:** ✅ **適合**

```csharp
// TerminalController.cs
try
{
    var file = Request.Files["terminalFile"];
    // 処理...
}
catch (Exception ex)
{
    return Json(new { success = false, message = $"処理中にエラーが発生しました：{ex.Message}" });
}
```
- try-catch-finally構文が適切に使用されている

### 4.3. 例外処理の原則
**結果:** ✅ **適合**

- 例外は集約例外ハンドラーで処理する仕組みが実装されている（Global.asax.cs）

### 4.4. 例外処理における禁止事項
**結果:** ⚠️ **一部問題あり**

**問題箇所:**
```csharp
// TerminalController.cs 複数箇所
catch (Exception ex)
{
    return Json(new { success = false, message = $"処理中にエラーが発生しました：{ex.Message}" });
}

// BaseController.cs
catch (Exception)
{
    return false;
}
```
**問題点:** `catch (Exception ex)` の使用が規約で禁止されているが、複数箇所で使用されている

---

## 5. Disposeメソッド

### 5.1. マネージリソースとアンマネージリソース
**結果:** ✅ **理解されている**

### 5.2. ガベージコレクターの動作
**結果:** ✅ **理解されている**

### 5.3. IDisposable インターフェース
**結果:** ✅ **適合**

### 5.4. using ステートメント
**結果:** ✅ **適合**

```csharp
// BusinessLogic/TerminalBusinessLogic.cs
using (var reader = new StreamReader(file.InputStream, Encoding.GetEncoding("Shift_JIS")))
{
    // 処理...
}

// DataAccess/TerminalDataAccess.cs
using (var connection = new SqlConnection(connectionString))
{
    // 処理...
}
```
- IDisposableオブジェクトに対してusingステートメントが適切に使用されている

---

## 総合評価

### ✅ 適合項目
- インデント、改行、{}の配置
- 変数・メソッド・クラス・プロパティの命名規則
- アクセス修飾子の指定
- usingステートメントの使用
- 基本的な例外処理構文

### 🟡 要改善項目
- 長い行の適切な折行（複数箇所）
- 論理演算子後の不要なスペース（1箇所）
- コメントアウトされたコードの残存（1箇所）

### ⚠️ 重要な問題
- **1ファイル1クラスの原則違反**（TerminalRegistModel.cs）
- **catch (Exception ex)の禁止規約違反**（複数箇所）

---

## 修正推奨事項

### 高優先度
1. `TerminalRegistModel.cs`から`SimRegistModel`クラスを別ファイルに分離
2. `catch (Exception ex)`を具体的な例外型での捕捉に変更

### 中優先度  
3. 長い行（特にJson返却文）の適切な折行
4. 論理演算子後の不要なスペース除去

### 低優先度
5. コメントアウトされたコード行の処理（削除またはTODOコメント追加）

全体的には、コーディング規約に良く準拠したコードが記述されていますが、上記の改善点を修正することで、より規約に準拠したコードになります。
