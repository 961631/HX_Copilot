# ソースコード比較資料

## 概要
hello-world-java-main配下のソースコード（MVC形式）とTerminal配下のソースコード（WebForms形式）を比較し、類似する処理内容について分析を行った結果を示します。

---

## 1. 権限チェック処理の比較

### hello-world-java-main（MVC形式）
**ファイル**: `Controllers/TerminalController.cs`

```csharp
/// <summary>
/// 権限チェック
/// </summary>
private bool CheckAuthorization()
{
    var userRole = GetCurrentUserRole();
    return userRole == "21" || userRole == "60" || userRole == "99"; // 事務センター責任者、工業担当者、管理者権限
}

// 使用例（各アクションメソッドで呼び出し）
[HttpGet]
public ActionResult Top()
{
    // 権限チェック
    if (!CheckAuthorization())
    {
        return RedirectToAction("Error", "Home");
    }
    return View();
}
```

### Terminal（WebForms形式）
**ファイル**: `Terminal/Top.aspx.cs`

```csharp
protected void Page_Load(object sender, EventArgs e)
{
    if (!IsPostBack)
    {
        ModelUser user = UserManager.GetUser();
        if (user.Role != BcBusinessValues.ROLE.ADMIN
            && user.Role != BcBusinessValues.ROLE.COCO_JIMU_ADMIN
            && user.Role != BcBusinessValues.ROLE.SECOM_KOGYO
            )
        {
            string script = "<script language = 'JavaScript'>alert('本ページを表示する権限がありません。');location.href='" + UIValues.URL.ROOT + "';</script>";
            ClientScript.RegisterClientScriptBlock(this.GetType(), "Error", script);
            return;
        }
    }
}
```

**類似点**:
- 両方とも管理者権限、事務センター権限、工業担当者権限をチェック
- 権限がない場合はエラー処理を実行

**相違点**:
- MVCはメソッドで抽象化、WebFormsは各ページで直接実装
- MVCはリダイレクト、WebFormsはJavaScriptアラート＋リダイレクト
- 権限値の表現方法が異なる（文字列 vs 定数）

---

## 2. CSVファイルアップロード処理の比較

### hello-world-java-main（MVC形式）
**ファイル**: `Controllers/TerminalController.cs`

```csharp
[HttpPost]
public ActionResult UploadTerminalCsv()
{
    try
    {
        var file = Request.Files["terminalFile"];
        
        // ファイルバリデーション
        var fileValidation = terminalLogic.ValidateCsvFile(file);
        if (!fileValidation.IsValid)
        {
            return Json(new { success = false, message = string.Join("\n", fileValidation.Errors) });
        }

        // CSVファイル処理
        var result = terminalLogic.ProcessTerminalCsvFile(file, "Regist.aspx", GetCurrentUserId());
        
        if (result.IsValid)
        {
            return Json(new { success = true, message = result.Message });
        }
        else
        {
            return Json(new { success = false, message = string.Join("\n", result.Errors) });
        }
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = $"処理中にエラーが発生しました：{ex.Message}" });
    }
}
```

**ビジネスロジック**: `BusinessLogic/TerminalBusinessLogic.cs`

```csharp
public ValidationResult ValidateCsvFile(HttpPostedFileBase file)
{
    var result = new ValidationResult();

    // ファイル存在チェック
    if (file == null || file.ContentLength == 0)
    {
        result.AddError("ファイルが選択されていません。");
        return result;
    }

    // 拡張子チェック
    var extension = Path.GetExtension(file.FileName).ToLower();
    if (extension != ".csv")
    {
        result.AddError("ファイル形式が正しくありません。CSVファイルをアップロードしてください。");
        return result;
    }

    return result;
}
```

### Terminal（WebForms形式）
**ファイル**: `Terminal/Regist.aspx.cs`

```csharp
protected void btnFileUpload1_Click(object sender, EventArgs e)
{
    Response.Redirect(UIValues.URL.TERMINAL_REGIST);
}

protected void btnFileUpload2_Click(object sender, EventArgs e)
{
    Response.Redirect(UIValues.URL.TERMINAL_REGIST);
}
```

**類似点**:
- どちらもファイルアップロード機能を提供

**相違点**:
- MVCは詳細なバリデーション、JSONレスポンス、例外処理を実装
- WebFormsは単純なリダイレクト処理のみ
- MVCはビジネスロジック層を分離、WebFormsはコードビハインドに集約

---

## 3. データ一覧表示処理の比較

### hello-world-java-main（MVC形式）
**ファイル**: `Controllers/TerminalController.cs`

```csharp
[HttpGet]
public ActionResult Result(int page = 1)
{
    if (!CheckAuthorization())
    {
        return RedirectToAction("Error", "Home");
    }

    try
    {
        var himodukeList = himodukeLogic.GetTodayHimodukeList(page);
        
        ViewBag.CurrentPage = page;
        ViewBag.HasData = himodukeList.Count > 0;
        
        if (himodukeList.Count == 0)
        {
            ViewBag.NoDataMessage = "本日登録されたデータはありません。";
        }

        return View(himodukeList);
    }
    catch (Exception ex)
    {
        ViewBag.ErrorMessage = $"データ取得中にエラーが発生しました：{ex.Message}";
        return View(new List<TerminalSimHimodukeModel>());
    }
}
```

### Terminal（WebForms形式）
**ファイル**: `Terminal/Result.aspx.cs`

```csharp
private void SetList()
{
    BcTerminal bcTanmatsu = new BcTerminal();
    DataSetHX.TERMINAL_SIM_HIMODUKEDataTable dt = new DataSetHX.TERMINAL_SIM_HIMODUKEDataTable();

    dt = bcTanmatsu.GetByRegistDate(DateTime.Now.ToString("yyyyMMdd"));
    this.dgHimozukeList.DataSource = dt;
    this.dgHimozukeList.DataBind();

    if (dt.Rows.Count == 0)
    {
        this.lblInfo.Text = "本日登録されたデータはありません。";
    }
    else
    {
        this.lblInfo.Text = "本日 " + DateTime.Now.ToString("yyyy/MM/dd") + " の登録内容は下記です。";
    }
}
```

**類似点**:
- 当日のデータを取得して表示
- データがない場合のメッセージ表示
- データバインディングによる一覧表示

**相違点**:
- MVCはページング対応、WebFormsは全件表示
- MVCは例外処理とViewBagでデータ渡し、WebFormsは直接コントロール操作
- データアクセス方法（モデル vs DataTable）

---

## 4. データ削除処理の比較

### hello-world-java-main（MVC形式）
**ファイル**: `Controllers/TerminalController.cs`

```csharp
[HttpPost]
public ActionResult DeleteHimoduke(string terminalNo, string icCardNo)
{
    try
    {
        var result = himodukeLogic.DeleteHimoduke(terminalNo, icCardNo);
        
        if (result.IsValid)
        {
            return Json(new { success = true, message = result.Message });
        }
        else
        {
            return Json(new { success = false, message = string.Join("\n", result.Errors) });
        }
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = $"削除処理中にエラーが発生しました：{ex.Message}" });
    }
}
```

### Terminal（WebForms形式）
**ファイル**: `Terminal/Result.aspx.cs`

```csharp
protected void dgHimozukeList_ItemCommand(object source, DataGridCommandEventArgs e)
{
    if (e.CommandName == "delete")
    {
        if (this.hdnDelFlg.Value == "1")
        {
            BcTerminal bcTanmatsu = new BcTerminal();
            DataSetHX.TERMINAL_SIM_HIMODUKEDataTable dt = new DataSetHX.TERMINAL_SIM_HIMODUKEDataTable();
            Label lblIMEI = (Label)e.Item.FindControl("lblIMEI");
            Label lblICCID = (Label)e.Item.FindControl("lblICCID");

            this.hdnDelFlg.Value = "0";
            dt = bcTanmatsu.GetByKeyHimo(lblIMEI.Text, lblICCID.Text);

            if (dt.Rows.Count > 0)
            {
                dt.Rows[0].Delete();
                bcTanmatsu.DeleteHimoduke(dt);
                this.ClientScript.RegisterClientScriptBlock(this.GetType(), "DONE", "alert('削除しました。');", true);
                SetList();
            }
        }
    }
}
```

**類似点**:
- 端末番号とICカード番号で削除対象を特定
- 削除後にメッセージ表示
- 削除後にリストを再表示

**相違点**:
- MVCはAjaxでJSONレスポンス、WebFormsはポストバックとJavaScriptアラート
- MVCはビジネスロジック層で削除処理、WebFormsは直接データアクセス
- エラーハンドリングの方法が異なる

---

## 5. データ登録・バリデーション処理の比較

### hello-world-java-main（MVC形式）
**ファイル**: `Controllers/TerminalController.cs`

```csharp
[HttpPost]
public ActionResult RegisterHimoduke(string terminalNo, string icCardNo)
{
    try
    {
        var result = himodukeLogic.ProcessHimoduke(terminalNo, icCardNo, "Himoduke.aspx", GetCurrentUserId());
        
        if (result.IsValid)
        {
            ViewBag.SuccessMessage = result.Message;
            // 入力フィールドクリア用
            ModelState.Clear();
            return View("Himoduke");
        }
        else
        {
            ViewBag.ErrorMessage = string.Join("\n", result.Errors);
            return View("Himoduke");
        }
    }
    catch (Exception ex)
    {
        ViewBag.ErrorMessage = $"処理中にエラーが発生しました：{ex.Message}";
        return View("Himoduke");
    }
}
```

### Terminal（WebForms形式）
**ファイル**: `Terminal/Himoduke.aspx.cs`

```csharp
protected void btnRegist_Click(object sender, EventArgs e)
{
    BcTerminal bcTanmatsu = new BcTerminal();
    DataSetHX.TERMINAL_SIM_HIMODUKEDataTable dt = new DataSetHX.TERMINAL_SIM_HIMODUKEDataTable();
    CcErrInfo ei = new CcErrInfo();

    // エラーチェック
    ei = CheckInput();

    if (!ei.HasError())
    {
        DataSetHX.TERMINAL_SIM_HIMODUKERow dr = dt.NewTERMINAL_SIM_HIMODUKERow();
        dr["TERMINAL_NO"] = this.txt_IMEI.Text;
        dr["IC_CARD_NO"] = this.txt_ICCID.Text;
        dr["REGIST_DATE"] = DateTime.Now;
        dr["R3_SEND_FLG"] = "0";
        dt.AddTERMINAL_SIM_HIMODUKERow(dr);

        // テーブル更新
        ei = bcTanmatsu.UpdateHimoduke(dt, UserManager.GetUser());
    }

    if (!ei.HasError())
    {
        this.ClientScript.RegisterClientScriptBlock(this.GetType(), "DONE", "alert('登録しました。');", true);
        this.lblInfo.Visible = true;
        this.lblErrInfo.Visible = false;
        this.lblInfo.Text = "端末製造番号：" + this.txt_IMEI.Text + "、SIM情報：" + this.txt_ICCID.Text + "で紐付け登録しました。";

        this.txt_IMEI.Text = "";
        this.txt_ICCID.Text = "";
        this.txt_IMEI.Focus();
    }
    else
    {
        this.ClientScript.RegisterClientScriptBlock(this.GetType(), "ALERT", "alert('エラーが発生しました。');", true);
        this.lblInfo.Visible = false;
        this.lblErrInfo.Visible = true;
        this.lblErrInfo.Text = ei.ToString();
    }
}

private CcErrInfo CheckInput()
{
    CcErrInfo ei = new CcErrInfo();
    BcTerminal bcTanmatsu = new BcTerminal();
    string terminalNo = this.txt_IMEI.Text;
    string icCardNo = this.txt_ICCID.Text;

    // 端末製造番号の桁数チェック
    if (terminalNo.Length != 15)
    {
        ei.AddErrMsg("端末製造番号：" + terminalNo + "は桁数が正しくないためエラーとなりました。");
    }
    // 端末製造番号の半角文字チェック
    if (!CcUtility.IsHankakuOnly(terminalNo))
    {
        ei.AddErrMsg("端末製造番号：" + terminalNo + "が半角英数字ではないためエラーとなりました。");
    }
    
    // SIM情報の桁数チェック
    if (icCardNo.Length != 19)
    {
        ei.AddErrMsg("ＳＩＭ情報（ＩＣＣＩＤ）：" + icCardNo + "は桁数が正しくないためエラーとなりました。");
    }
    // SIM情報の半角文字チェック
    if (!CcUtility.IsHankakuOnly(icCardNo))
    {
        ei.AddErrMsg("ＳＩＭ情報（ＩＣＣＩＤ）：" + icCardNo + "が半角英数字ではないためエラーとなりました。");
    }

    return ei;
}
```

**類似点**:
- 端末製造番号とSIM情報の紐付け登録
- 桁数チェックと半角文字チェック
- 重複チェック
- 成功・エラー時のメッセージ表示

**相違点**:
- MVCはビジネスロジック層でバリデーション、WebFormsはコードビハインドで実装
- MVCはViewBagでメッセージ渡し、WebFormsは直接ラベル操作
- MVCはModelState.Clear()でフィールドクリア、WebFormsは直接Text=""で設定

---

## 6. ナビゲーション処理の比較

### hello-world-java-main（MVC形式）
**ファイル**: `Controllers/TerminalController.cs`

```csharp
[HttpGet]
public ActionResult Top()
{
    if (!CheckAuthorization())
    {
        return RedirectToAction("Error", "Home");
    }
    return View();
}

[HttpGet]
public ActionResult Regist()
{
    if (!CheckAuthorization())
    {
        return RedirectToAction("Error", "Home");
    }
    return View();
}
```

### Terminal（WebForms形式）
**ファイル**: `Terminal/Top.aspx.cs`

```csharp
protected void btnTanmatsu_Click(object sender, EventArgs e)
{
    Response.Redirect(UIValues.URL.TERMINAL_REGIST);
}

protected void btnTanmatsuHimoduke_Click(object sender, EventArgs e)
{
    Response.Redirect(UIValues.URL.TERMINAL_HIMODUKE);
}

protected void btnTanmatsuList_Click(object sender, EventArgs e)
{
    Response.Redirect(UIValues.URL.TERMINAL_RESULT);
}
```

**類似点**:
- 画面遷移機能
- 権限チェック後の画面表示

**相違点**:
- MVCはルーティングとActionResult、WebFormsはResponse.Redirect
- MVCは定数URLではなくアクション名指定、WebFormsはURL定数使用

---

## まとめ

### 共通の機能要件
1. **権限チェック**: 管理者、事務センター責任者、工業担当者の権限確認
2. **CSVアップロード**: 端末情報とSIM情報のファイルアップロード
3. **データ紐付け**: 端末とSIMの紐付け登録
4. **データ一覧**: 当日登録データの表示
5. **データ削除**: 紐付け情報の削除
6. **バリデーション**: 桁数、半角文字、重複チェック

### アーキテクチャの違い

| 項目 | hello-world-java-main (MVC) | Terminal (WebForms) |
|------|----------------------------|---------------------|
| アーキテクチャパターン | Model-View-Controller | コードビハインド |
| データアクセス | モデルクラス + ビジネスロジック層 | DataTable + ビジネスクラス |
| バリデーション | ValidationResultクラス | CcErrInfoクラス |
| エラーハンドリング | try-catch + JSON/ViewBag | try-catch + JavaScript Alert |
| 画面遷移 | RedirectToAction | Response.Redirect |
| データバインディング | ViewとModel | DataGrid + DataTable |
| 非同期処理 | Ajax + JSON | ポストバック |

### 移行時の考慮事項
- WebFormsからMVCへの移行では、コードビハインドロジックをコントローラーとビジネスロジック層に分離する必要がある
- DataTableベースの処理をモデルクラスベースに変更
- JavaScriptアラートからAjax + JSONレスポンスへの変更
- サーバーコントロールから HTML Helper/Razorビューへの変更
