# 救急情報管理システム　みまもりホン後継機対応

**プロジェクト名**: 救急情報管理システム　みまもりホン後継機対応  
**ドキュメント名**: 集約改善  
**作成者**: 髙橋  
**作成日**: 2023/9/22  

## ■機能概要

みまもりホン端末の新規端末情報登録機能として、以下の3つの画面機能を提供する。

1. **KDDI受領データ登録** - 端末データとSIMデータのCSVファイルアップロード機能
2. **端末-SIM情報紐付け登録** - 端末情報とSIM情報の紐付け機能  
3. **SIM情報紐付け結果一覧** - 紐付け結果の一覧表示・削除機能

## ■権限管理

| 権限 | KDDI受領データ登録 | 端末-SIM情報紐付け登録 | SIM情報紐付け結果一覧 |
|---|---|---|---|
| セコム工業管理者 | ○ | ○ | ○ |
| セコム工業担当者 | ○ | ○ | ○ |

## ■機能詳細

### 【１】トップ

#### （１）ＵＲＬ
- 現行システムのトップ画面に「新規端末情報登録（仮）」のタブを追加
- 押下で登録画面へ遷移

#### （２）ボタン制御
- **KDDI受領データ登録**: CSVファイルアップロード画面へ遷移
- **端末-SIM情報紐付け登録**: 端末とSIMの紐付け画面へ遷移  
- **SIM情報紐付け結果一覧**: 紐付け結果一覧画面へ遷移

### 【２】ＫＤＤＩ受領データ登録

#### （１）ボタン制御
- **端末データ登録**: 端末情報CSVファイルをアップロード
- **SIMデータ登録**: SIM情報CSVファイルをアップロード
- **メニューへ戻る**: トップ画面へ戻る

#### （２）画面制御
##### アップロードボタン押下時
- ファイル選択ダイアログを表示
- CSVファイル選択後、即座にDB登録処理を実行

#### １．端末データ登録

##### ●ファイルレイアウト
| 列 | 項目名 | 備考 |
|---|---|---|
| A | No | DB取り込み無し |
| B | 端末製造番号（IMEI）１ | DB取り込み有り |
| C | 端末製造番号（IMEI）２ | DB取り込み有り（現行機ではNULLのため、パラメータチェック対象外） |
| D | 機器PINコード | DB取り込み有り |
| E | 納品予定日 | DB取り込み無し |
| F | 商品コード | DB取り込み有り |
| G | 商品名 | DB取り込み無し |

##### ●ファイルチェック
###### 拡張子チェック
- 対象拡張子：.csv
- エラー時：「ファイル形式が正しくありません。CSVファイルをアップロードしてください。」

###### パラメータチェック
| 列 | 項目名 | DBパラメータ名 | 最小桁数 | 最大桁数 | 備考 |
|---|---|---|---|---|---|
| B | 端末製造番号（IMEI）１ | TERMINAL_NO_1 | 15 | 15 | - |
| C | 端末製造番号（IMEI）２ | TERMINAL_NO_2 | 15 | 15 | パラメータチェック対象外 |
| D | 機器PINコード | PIN_CD | 5 | 5 | - |
| F | 商品コード | ITEM_CD | 8 | 8 | - |

- エラー時：「端末製造番号：XXXXXXXXXXXの桁数が正しくないためエラーとなりました。内容を確認し、再度アップロードしてください。」

###### 重複チェック
- チェック対象：端末製造番号（IMEI）１
- エラー時：「端末製造番号：XXXXXXXXXXは既に登録されているためファイルアップロードできません。」

##### ●ＤＢ登録
- テーブル：NEW_TERMINAL_INFO
- 登録成功時：「端末データの登録が完了しました。」

#### ２．ＳＩＭデータ登録

##### ●ファイルレイアウト
| 列 | 項目名 | 備考 |
|---|---|---|
| A | No | DB取り込み無し |
| B | 端末電話番号 | DB取り込み有り |
| C | 加入者コード | DB取り込み有り |
| D | 製造番号（ICカード） | DB取り込み有り |
| E | ネットワーク暗証番号 | DB取り込み有り |
| F | PINロック解除 | DB取り込み有り |
| G | 機器PINコード | DB取り込み無し |
| H | 納品予定日 | DB取り込み無し |
| I | 受注日 | DB取り込み無し |

##### ●ファイルチェック
###### 拡張子チェック
- 対象拡張子：.csv
- エラー時：「ファイル形式が正しくありません。CSVファイルをアップロードしてください。」

###### パラメータチェック
| 列 | 項目名 | DBパラメータ名 | 最小桁数 | 最大桁数 | 備考 |
|---|---|---|---|---|---|
| B | 端末電話番号 | MDP_TEL | 11 | 11 | - |
| C | 加入者コード | KANYUSYA_CD | 8 | 8 | - |
| D | 製造番号（ICカード） | IC_CARD_NO | 19 | 19 | - |
| E | ネットワーク暗証番号 | NETWORK_PASSWORD | 4 | 4 | - |
| F | PINロック解除 | SIM_UNLOCK_CD | 8 | 8 | - |

- エラー時：「電話番号XXXXXXXXXXXの桁数が正しくないためエラーとなりました。内容を確認し、再度アップロードしてください。」

###### 重複チェック
- チェック対象：端末電話番号
- エラー時：「端末電話番号：XXXXXXXXXXは既に登録されているためファイルアップロードできません。」

##### ●ＤＢ登録
- テーブル：NEW_SIM_INFO
- 登録成功時：「SIMデータの登録が完了しました。」

#### ３．登録完了後
- アップロード完了メッセージを表示
- 続けて別のファイルをアップロード可能

### 【３】端末-ＳＩＭ情報紐付け登録

#### （１）ボタン制御
- **登録**: 入力された端末製造番号とSIM情報を紐付けてDB登録
- **メニューへ戻る**: トップ画面へ戻る

#### （２）画面制御
- 端末製造番号（IMEI）入力フィールド
- SIM情報（ICCID）入力フィールド
- 登録ボタン押下で紐付け処理実行

#### １．パラメータチェック

##### 入力チェック
| No | 項目名 | DBパラメータ名 | 最小桁数 | 最大桁数 | 備考 |
|---|---|---|---|---|---|
| 1 | 端末製造番号（IMEI） | TERMINAL_NO | 15 | 15 | - |
| 2 | SIM情報（ICCID） | IC_CARD_NO | 19 | 19 | - |

- エラー時：「端末製造番号：XXXXXXは桁数が正しくないためエラーとなりました。入力内容を確認し再登録してください。」

##### 重複チェック
- チェック対象：端末電話番号の重複
- エラー時：「端末電話番号：XXXXXXXXXXは既に登録されているため紐付けできません。」

#### ２．ＤＢ登録
- テーブル：NEW_TERMINAL_SIM_LINK
- 登録項目：端末製造番号、SIM情報、登録日時
- 登録成功時：「端末-SIM情報の紐付けが完了しました。」

#### ３．登録完了後
- 入力フィールドをクリア
- 続けて別の紐付け登録が可能

### 【４】端末-SIM情報紐付け結果一覧

#### （１）ボタン制御
- **削除**: 選択した紐付け情報を削除

#### （２）画面制御

#### １．一覧表示
- 紐付け済みの端末-SIM情報を一覧表示
- 表示項目：
  - 端末製造番号（IMEI）
  - SIM情報（ICCID）
  - 端末電話番号
  - 登録日時
  - 削除ボタン

#### ２．削除
- 削除ボタン押下で確認ダイアログ表示
- 確認後、該当レコードを物理削除
- 削除完了メッセージ：「紐付け情報を削除しました。」

## ■データベース設計

### NEW_TERMINAL_INFO（端末情報テーブル）
| カラム名 | データ型 | 制約 | 説明 |
|---|---|---|---|
| TERMINAL_NO_1 | VARCHAR(15) | PK, NOT NULL | 端末製造番号１ |
| TERMINAL_NO_2 | VARCHAR(15) | NULL | 端末製造番号２ |
| PIN_CD | VARCHAR(5) | NOT NULL | 機器PINコード |
| ITEM_CD | VARCHAR(8) | NOT NULL | 商品コード |
| REG_DATE | DATETIME | NOT NULL | 登録日時 |

### NEW_SIM_INFO（SIM情報テーブル）
| カラム名 | データ型 | 制約 | 説明 |
|---|---|---|---|
| MDP_TEL | VARCHAR(11) | PK, NOT NULL | 端末電話番号 |
| KANYUSYA_CD | VARCHAR(8) | NOT NULL | 加入者コード |
| IC_CARD_NO | VARCHAR(19) | NOT NULL | 製造番号（ICカード） |
| NETWORK_PASSWORD | VARCHAR(4) | NOT NULL | ネットワーク暗証番号 |
| SIM_UNLOCK_CD | VARCHAR(8) | NOT NULL | PINロック解除 |
| REG_DATE | DATETIME | NOT NULL | 登録日時 |

### NEW_TERMINAL_SIM_LINK（端末-SIM紐付けテーブル）
| カラム名 | データ型 | 制約 | 説明 |
|---|---|---|---|
| LINK_ID | INT | PK, AUTO_INCREMENT | 紐付けID |
| TERMINAL_NO | VARCHAR(15) | FK, NOT NULL | 端末製造番号 |
| IC_CARD_NO | VARCHAR(19) | FK, NOT NULL | SIM情報（ICCID） |
| MDP_TEL | VARCHAR(11) | FK, NOT NULL | 端末電話番号 |
| REG_DATE | DATETIME | NOT NULL | 登録日時 |

## ■画面遷移図

```
トップ画面
├─ KDDI受領データ登録
│  ├─ 端末データ登録（CSVアップロード）
│  ├─ SIMデータ登録（CSVアップロード）
│  └─ メニューへ戻る → トップ画面
├─ 端末-SIM情報紐付け登録
│  ├─ 登録処理
│  └─ メニューへ戻る → トップ画面
└─ SIM情報紐付け結果一覧
   ├─ 一覧表示
   ├─ 削除処理
   └─ メニューへ戻る → トップ画面
```
