# 救急情報管理システム　みまもりホン後継機対応

**プロジェクト名**: 救急情報管理システム　みまもりホン後継機対応  
**ドキュメント名**: 工業登録作業の改善 
**作成者**: 髙橋  
**作成日**: 2023/9/22  

## ■機能概要
みまもりホン端末の新規端末情報登録機能として、以下の3つの画面機能を提供する。

1. **KDDI受領データ登録** - 端末データとSIMデータのCSVファイルアップロード機能
2. **端末-SIM情報紐付け登録** - 端末情報とSIM情報の紐付け機能  
3. **SIM情報紐付け結果一覧** - 紐付け結果の一覧表示・削除機能

## ■権限管理
下記の権限（AUTH_MST.ROLE_ID）でのみ利用可能とする。下記以外の権限がURL直指定で画面を開いた場合はエラーとする。

| 権限（ROLE_ID） | KDDI受領データ登録 | 端末-SIM情報紐付け登録 | SIM情報紐付け結果一覧 |
|---|---|---|---|
| 事務センター責任者（21） | ○ | ○ | ○ |
| 工業担当者（60） | ○ | ○ | ○ |
| 管理者権限（99） | ○ | ○ | ○ |

## ■機能詳細

### 【１】トップ

#### （１）ＵＲＬ
- 現行システムのトップ画面に「新規端末情報登録」のタブを追加
- 押下で登録画面へ遷移
検証：http://gcwwqv00.intra.secom.co.jp/HX/Terminal/Top.aspx																																												
本番：http://gcwwpv00.intra.secom.co.jp/HX/Terminal/Top.aspx																																																
#### （２）ボタン制御
- **KDDI受領データ登録**: CSVファイルアップロード画面へ遷移
- **端末-SIM情報紐付け登録**: 端末とSIMの紐付け画面へ遷移  
- **SIM情報紐付け結果一覧**: 紐付け結果一覧画面へ遷移

KDDI受領データ登録

「登録」押下後下記の画面へ遷移

検証：http://gcwwqv00.intra.secom.co.jp/HX/Terminal/Regist.aspx

本番：http://gcwwpv00.intra.secom.co.jp/HX/Terminal/Regist.aspx

端末-SIM情報紐付け登録

「登録」押下後下記の画面へ遷移

検証：http://gcwwqv00.intra.secom.co.jp/HX/Terminal/Himoduke.aspx

本番：http://gcwwpv00.intra.secom.co.jp/HX/Terminal/Himoduke.aspx
											
SIM情報紐付け結果一覧

「登録」押下後下記の画面へ遷移

検証：http://gcwwqv00.intra.secom.co.jp/HX/Terminal/Result.aspx

本番：http://gcwwpv00.intra.secom.co.jp/HX/Terminal/Result.aspx	

### 【２】ＫＤＤＩ受領データ登録

#### （１）ボタン制御
- **端末データ登録**: 「端末データ登録」ボタン押下後、ファイルアップロードのポップアップを表示する。
ポップアップ上では「参照」ボタンでファイルを指定して「アップロード」ボタンでアップロードする。「クリア」押下で現在の入力値をクリアする。
- **SIMデータ登録**: 「SIMデータ登録」ボタン押下後、ファイルアップロードのポップアップを表示する。
ポップアップ上では「参照」ボタンでファイルを指定して「アップロード」ボタンでアップロードする。「クリア」押下で現在の入力値をクリアする。
- **メニューへ戻る**: トップメニューへ遷移
（トップメニュー検証：http://gcwwqv00.intra.secom.co.jp/HX/、トップメニュー本番：http://gcwwpv00.intra.secom.co.jp/HX/）	

#### （２）画面制御
##### アップロードボタン押下時
- ファイル選択ダイアログを表示
- CSVファイル選択後、即座にDB登録処理を実行

#### １．端末データ登録

##### ●ファイルレイアウト
| 列 | 項目名 | 備考 |
|---|---|---|
| A | No | DB取り込み無し |
| B | 端末製造番号（IMEI）１ | DB取り込み有り |
| C | 端末製造番号（IMEI）２ | DB取り込み有り（現行機ではNULLのため、パラメータチェック対象外） |
| D | 機器PINコード | DB取り込み有り |
| E | 納品予定日 | DB取り込み無し |
| F | 商品コード | DB取り込み有り |
| G | 商品名 | DB取り込み無し |

##### ●ファイルチェック
###### 拡張子チェック
- 対象拡張子：.csv
- エラー時：「ファイル形式が正しくありません。CSVファイルをアップロードしてください。」

###### パラメータチェック
| 列 | 項目名 | DBパラメータ名 | 最小桁数 | 最大桁数 | 備考 |
|---|---|---|---|---|---|
| B | 端末製造番号（IMEI）１ | TERMINAL_NO_1 | 15 | 15 | - |
| C | 端末製造番号（IMEI）２ | TERMINAL_NO_2 | 15 | 15 | パラメータチェック対象外 |
| D | 機器PINコード | PIN_CD | 5 | 5 | - |
| F | 商品コード | ITEM_CD | 8 | 8 | 桁数不足/過多、全角文字チェック |

- エラー時：「端末製造番号：XXXXXXXXXXXの桁数が正しくないためエラーとなりました。内容を確認し、再度アップロードしてください。」

###### 重複チェック
- チェック対象：端末製造番号（IMEI）１
- エラー時：「端末製造番号：XXXXXXXXXXは既に登録されているためファイルアップロードできません。」
| ファイルパラメータ | 対象DB項目 |
| 端末製造番号      | HX.NEW_TERMINAL_REGIST.TERMINAL_NO |
|                  | HX.MAMORINO_MST.TERMINAL_NO |

##### ●ＤＢ登録
- テーブル：NEW_TERMINAL_REGIST
- 登録成功時：「端末データの登録が完了しました。」

##### ●登録値とDB項目の対応

###### システム登録項目とDB項目の対応

| 登録値 | 対象ＤＢ項目 |
|---|---|
| 登録日時 | HX.NEW_TERMINAL_REGIST.CREATE_DATE |
| ＷＥＢページ名 | HX.NEW_TERMINAL_REGIST.CREATE_PROGRAM_ID |
| ログインユーザー社員番号 | HX.NEW_TERMINAL_REGIST.CREATE_USER_ID |
| 登録日時 | HX.NEW_TERMINAL_REGIST.MODIFIED_DATE |
| ＷＥＢページ名 | HX.NEW_TERMINAL_REGIST.MODIFIED_PROGRAM_ID |
| ログインユーザー社員番号 | HX.NEW_TERMINAL_REGIST.MODIFIED_USER_ID |

###### ファイルパラメータとDB項目の対応

| ファイルパラメータ | 対象ＤＢ項目 |
|---|---|
| 端末製造番号（ＩＭＥＩ） | HX.NEW_TERMINAL_REGIST.TERMINAL_NO_1 |
| 端末製造番号（ＩＭＥＩ） | HX.NEW_TERMINAL_REGIST.TERMINAL_NO_2 |
| 機器PINコード | HX.NEW_TERMINAL_REGIST.PIN_CD |
| 商品コード | HX.NEW_TERMINAL_REGIST.ITEM_CD |

#### ２．ＳＩＭデータ登録

##### ●ファイルレイアウト
| 列 | 項目名 | 備考 |
|---|---|---|
| A | No | DB取り込み無し |
| B | 端末電話番号 | DB取り込み有り |
| C | 加入者コード | DB取り込み有り |
| D | 製造番号（ICカード） | DB取り込み有り |
| E | ネットワーク暗証番号 | DB取り込み有り |
| F | PINロック解除 | DB取り込み有り |
| G | 機器PINコード | DB取り込み無し |
| H | 納品予定日 | DB取り込み無し |
| I | 受注日 | DB取り込み無し |

##### ●ファイルチェック
###### 拡張子チェック
- 対象拡張子：.csv
- エラー時：「ファイル形式が正しくありません。CSVファイルをアップロードしてください。」

###### パラメータチェック
| 列 | 項目名 | DBパラメータ名 | 最小桁数 | 最大桁数 | 備考 |
|---|---|---|---|---|---|
| B | 端末電話番号 | MDP_TEL | 11 | 11 | - |
| C | 加入者コード | KANYUSYA_CD | 8 | 8 | - |
| D | 製造番号（ICカード） | IC_CARD_NO | 19 | 19 | - |
| E | ネットワーク暗証番号 | NETWORK_PASSWORD | 4 | 4 | - |
| F | PINロック解除 | SIM_UNLOCK_CD | 8 | 8 | - |

- エラー時：「電話番号XXXXXXXXXXXの桁数が正しくないためエラーとなりました。内容を確認し、再度アップロードしてください。」

###### 重複チェック
- チェック対象：端末電話番号
- エラー時：「端末電話番号：XXXXXXXXXXは既に登録されているためファイルアップロードできません。」

###### SIMデータファイルパラメータとDB項目の対応

| ファイルパラメータ | 対象ＤＢ項目 |
|---|---|
| 端末電話番号 | HX.MAMORINO_MST.MDP_TEL |
|  | HX.NEW_SIM_REGIST.MDP_TEL |
| SIM情報（ＩＣＣＩＤ） | HX.MAMORINO_MST.IC_CARD_NO |
|  | HX.NEW_SIM_REGIST.IC_CARD_NO |

##### ●ＤＢ登録
- テーブル：NEW_SIM_REGIST
- 登録成功時：「SIMデータの登録が完了しました。」

##### ●SIMデータ登録時のヘッダー情報とファイルパラメータのDB項目対応

###### ヘッダー情報

| 登録値 | 対象ＤＢ項目 |
|---|---|
| 登録日時 | HX.NEW_SIM_REGIST.CREATE_DATE |
| ＷＥＢページ名 | HX.NEW_SIM_REGIST.CREATE_PROGRAM_ID |
| ログインユーザー社員番号 | HX.NEW_SIM_REGIST.CREATE_USER_ID |
| 登録日時 | HX.NEW_SIM_REGIST.MODIFIED_DATE |
| ＷＥＢページ名 | HX.NEW_SIM_REGIST.MODIFIED_PROGRAM_ID |
| ログインユーザー社員番号 | HX.NEW_SIM_REGIST.MODIFIED_USER_ID |

###### ファイルパラメータ

| ファイルパラメータ | 対象ＤＢ項目 |
|---|---|
| 端末電話番号 | HX.NEW_TERMINAL_REGIST.MDP_TEL |
| 加入者コード | HX.NEW_TERMINAL_REGIST.KANYUSYA_CD |
| ＳＩＭ情報（ＩＣＣＩＤ） | HX.NEW_TERMINAL_REGIST.IC_CARD_NO |
| ネットワーク暗証番号 | HX.NEW_TERMINAL_REGIST.NETWORK_PASSWORD |
| ＳＩＭロック解除コード | HX.NEW_TERMINAL_REGIST.SIM_UNLOCK_CD |

#### ３．登録完了後
- アップロード完了メッセージを表示

端末データ登録
端末データをＸＸＸ件登録しました。（Xには件数を表示）

ＳＩＭデータ登録
SIMデータをＸＸＸ件登録しました。（Xには件数を表示）

エラーの場合は登録時に、ロールバックしてファイルは取り込まない。また、１．、２．で記載した条件に基づいてエラーを表示する。

- 続けて別のファイルをアップロード可能

### 【３】端末-ＳＩＭ情報紐付け登録

#### （１）ボタン制御
- **登録**: 入力された端末製造番号とSIM情報を紐付けてDB（HX.TERMINAL_SIM_HIMODUKE）に登録
- **メニューへ戻る**: トップ画面へ戻る
（トップメニュー検証：http://gcwwqv00.intra.secom.co.jp/HX/、トップメニュー本番：http://gcwwpv00.intra.secom.co.jp/HX/）	

#### （２）画面制御
- 端末製造番号（IMEI）入力フィールド
- SIM情報（ICCID）入力フィールド
- 「登録」ボタン押下時に「端末製造番号（ＩＭＥＩ）」、「ＳＩＭ情報（ＩＣＣＩＤ）」をＤＢに登録する

#### １．パラメータチェック

##### 入力チェック
| No | 項目名 | DBパラメータ名 | 最小桁数 | 最大桁数 | 備考 |
|---|---|---|---|---|---|
| 1 | 端末製造番号（IMEI） | TERMINAL_NO | 15 | 15 | - |
| 2 | SIM情報（ICCID） | IC_CARD_NO | 19 | 19 | - |

- エラー時：「端末製造番号：XXXXXXは桁数が正しくないためエラーとなりました。入力内容を確認し再登録してください。」

##### 重複チェック
- チェック対象：端末電話番号の重複
- エラー時：
「端末電話番号：XXXXXXXXXXは既に登録されているため紐付けできません。」
「ＳＩＭ情報（ＩＣＣＩＤ）：XXXXXXXXXXは既に登録されているため紐付けできません。」

##### ●入力値とDB項目の対応

| 入力値 | 対象ＤＢ項目 |
|---|---|
| 端末製造番号（ＩＭＥＩ） | HX.TERMINAL_SIM_HIMODUKE.TERMINAL_NO |
| SIM情報（ＩＣＣＩＤ） | HX.TERMINAL_SIM_HIMODUKE.IC_CARD_NO |

#### ２．ＤＢ登録
- テーブル：NEW_TERMINAL_SIM_HIMODUKE
- 登録項目：端末製造番号、SIM情報、登録日時
- 登録成功時：「端末-SIM情報の紐付けが完了しました。」
- パラメータチェックを全て通過した場合のみ、ＤＢへ登録を行う。（ＩＮＳＥＲＴ）

##### ●DB登録値の詳細対応

| 登録値 | 対象ＤＢ項目 |
|---|---|
| 登録日時 | CREATED_DATE |
| ＷＥＢページ名 | CREATED_PROGRAM_ID |
| ログインユーザー社員番号 | CREATED_USER_ID |
| 登録日時 | MODIFIED_DATE |
| ＷＥＢページ名 | MODIFIED_PROGRAM_ID |
| ログインユーザー社員番号 | MODIFIED_USER_ID |
| "0" | DELETE_FLG |
| 画面入力値 | TERMINAL_NO |
| 画面入力値 | IC_CARD_NO |
| sysdate | REGIST_DATE |
| "0" | R3_SEND_FLG |

#### ３．登録完了後
- 入力フィールドをクリア
- 続けて別の紐付け登録が可能（入力欄は再度活性化し、カーソルはデフォルトで端末製造番号を選択するようにする）
- 登録完了文言を表示する（下記参考　※数列は例）
端末製造番号：352078107102667、SIM情報：8981300054198647148　で紐付け登録しました。
- 登録時エラーの場合は登録時に、１．、２．で記載した条件に基づいてエラーを表示する。


### 【４】端末-SIM情報紐付け結果一覧

#### （１）ボタン制御
- **削除**: 選択した紐付け情報を削除
「削除」ボタン押下で紐付けデータを削除する。（TERMINAL_SIM_HIMODUKEから該当レコードを物理削除(DELETE)する）

#### （２）画面制御

#### １．一覧表示
- 紐付け済みの端末-SIM情報を一覧表示
- 登録当日（TERMINAL_SIM_IHMODUKE.REGIST_DATEのYYYYMMDDが本日）の紐付けデータ一覧を表示する。
- 表示項目：
  - 端末製造番号（IMEI）
  - SIM情報（ICCID）
  - 削除ボタン
- 表示は１ページあたり20件を最大とし、20件以上のレコードが存在する場合にはページングする。
- レコードが存在しない場合は、ヘッダーのみ表示する。
- レコードが存在しない場合の画面表示文言：本日登録されたデータはありません。

#### ２．削除
- 削除ボタン押下で確認ダイアログ表示
- ダイアログ文言：該当の紐付け登録を削除してよろしいですか？
- 選択肢：　ＯＫ、キャンセル
- 確認後、該当レコードを物理削除
- 削除完了メッセージ：「紐付け情報を削除しました。」

## ■データベース設計

### NEW_TERMINAL_REGIST（端末情報テーブル）
| No | 項目名 | データ型 | 長さ | 小数 | 必須 | 主キー | 備考 |
|---|---|---|---|---|---|---|---|
| 1 | CREATED_DATE | DATE | - | - | - | - | ヘッダー:登録日付・時刻 |
| 2 | CREATED_PROGRAM_ID | VARCHAR2 | 20 | - | - | - | ヘッダー:登録プログラムID |
| 3 | CREATED_USER_ID | VARCHAR2 | 40 | - | - | - | ヘッダー:登録ユーザー（ログインユーザー） |
| 4 | MODIFIED_DATE | DATE | - | - | - | - | ヘッダー:最終更新日付・時刻 |
| 5 | MODIFIED_PROGRAM_ID | VARCHAR2 | 20 | - | - | - | ヘッダー:最終更新プログラムID（クラス名） |
| 6 | MODIFIED_USER_ID | VARCHAR2 | 40 | - | - | - | ヘッダー:最終更新ユーザー（ログインユーザー） |
| 7 | DELETE_FLG | CHAR | 1 | - | - | - | ヘッダー:削除フラグ<br>0:未削除 1:削除済 |
| 8 | TERMINAL_NO_1 | VARCHAR2 | 20 | - | Y | 1 | 端末製造番号（ＩＭＥＩ）1 |
| 9 | TERMINAL_NO_2 | VARCHAR2 | 20 | - | - | - | 端末製造番号（ＩＭＥＩ）2 |
| 10 | PIN_CD | VARCHAR2 | 10 | - | - | - | 機器PINコード |
| 11 | ITEM_CD | VARCHAR2 | 10 | - | - | - | 商品コード |

### NEW_SIM_REGIST（SIM情報テーブル）
| No | 項目名 | データ型 | 長さ | 小数 | 必須 | 主キー | 備考 |
|---|---|---|---|---|---|---|---|
| 1 | CREATED_DATE | DATE | - | - | - | - | ヘッダー:登録日付・時刻 |
| 2 | CREATED_PROGRAM_ID | VARCHAR2 | 20 | - | - | - | ヘッダー:登録プログラムID |
| 3 | CREATED_USER_ID | VARCHAR2 | 40 | - | - | - | ヘッダー:登録ユーザー（ログインユーザー） |
| 4 | MODIFIED_DATE | DATE | - | - | - | - | ヘッダー:最終更新日付・時刻 |
| 5 | MODIFIED_PROGRAM_ID | VARCHAR2 | 20 | - | - | - | ヘッダー:最終更新プログラムID（クラス名） |
| 6 | MODIFIED_USER_ID | VARCHAR2 | 40 | - | - | - | ヘッダー:最終更新ユーザー（ログインユーザー） |
| 7 | DELETE_FLG | CHAR | 1 | - | - | - | ヘッダー:削除フラグ<br>0:未削除 1:削除済 |
| 8 | MDP_TEL | VARCHAR2 | 13 | - | - | - | 端末電話番号 |
| 9 | KANYUSYA_CD | VARCHAR2 | 10 | - | - | - | 加入者コード |
| 10 | IC_CARD_NO | VARCHAR2 | 20 | - | Y | 1 | ＳＩＭ情報（ＩＣＣＩＤ） |
| 11 | NETWORK_PASSWORD | VARCHAR2 | 4 | - | - | - | ネットワーク暗証番号 |
| 12 | SIM_UNLOCK_CD | VARCHAR2 | 8 | - | - | - | SIMロック解除コード |

### TERMINAL_SIM_HIMODUKE（端末-SIM紐付けテーブル）
| No | 項目名 | データ型 | 長さ | 小数 | 必須 | 主キー | 備考 |
|---|---|---|---|---|---|---|---|
| 1 | CREATED_DATE | DATE | - | - | - | - | ヘッダー:登録日付・時刻 |
| 2 | CREATED_PROGRAM_ID | VARCHAR2 | 20 | - | - | - | ヘッダー:登録プログラムID |
| 3 | CREATED_USER_ID | VARCHAR2 | 40 | - | - | - | ヘッダー:登録ユーザー（ログインユーザー） |
| 4 | MODIFIED_DATE | DATE | - | - | - | - | ヘッダー:最終更新日付・時刻 |
| 5 | MODIFIED_PROGRAM_ID | VARCHAR2 | 20 | - | - | - | ヘッダー:最終更新プログラムID（クラス名） |
| 6 | MODIFIED_USER_ID | VARCHAR2 | 40 | - | - | - | ヘッダー:最終更新ユーザー（ログインユーザー） |
| 7 | DELETE_FLG | CHAR | 1 | - | - | - | ヘッダー:削除フラグ<br>0:未削除 1:削除済 |
| 8 | TERMINAL_NO | VARCHAR2 | 20 | - | Y | 1 | 端末製造番号（ＩＭＥＩ） |
| 9 | IC_CARD_NO | VARCHAR2 | 20 | - | Y | 2 | ＳＩＭ情報（ＩＣＣＩＤ） |
| 10 | REGIST_DATE | DATE | - | - | - | - | 登録日 |
| 11 | R3_SEND_FLG | VARCHAR2 | 1 | - | - | - | R/3連携ファイル作成フラグ（0:未作成　1:作成済み） |
| 12 | R3_SEND_DATE | DATE | - | - | - | - | R/3連携日 |

## ■画面遷移図

```
トップ画面
├─ KDDI受領データ登録
│  ├─ 端末データ登録（CSVアップロード）
│  ├─ SIMデータ登録（CSVアップロード）
│  └─ メニューへ戻る → トップ画面
├─ 端末-SIM情報紐付け登録
│  ├─ 登録処理
│  └─ メニューへ戻る → トップ画面
└─ SIM情報紐付け結果一覧
   ├─ 一覧表示
   ├─ 削除処理
   └─ メニューへ戻る → トップ画面
```
